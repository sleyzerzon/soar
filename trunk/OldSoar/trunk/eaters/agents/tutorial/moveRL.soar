#set fileId [open "log.txt" a]
#puts $fileId (clrf)

 
sp {add*directions
  (state <s> ^superstate nil)
-->
  (<s> ^directions <o>)
  (<o> ^north <north>
       ^west <west>
       ^south <south>
       ^east <east>)
  (<north> ^left west
       ^straight north
       ^right east)
  (<west> ^left south
       ^straight west
       ^right north)
  (<south> ^left east
       ^straight south
       ^right west)
  (<east> ^left north
       ^straight east
       ^right south)}
       
sp {add*content*west
  (state <s> ^superstate nil
             ^io.input-link.my-location.west.content <c>)
 -->
  (<s> ^content-west <c>)}
  
  
sp {add*content*east
  (state <s> ^superstate nil
             ^io.input-link.my-location.east.content <c>)
 -->
  (<s> ^content-east <c>)}
  
sp {add*content*north
  (state <s> ^superstate nil
             ^io.input-link.my-location.north.content <c>)
 -->
  (<s> ^content-north <c>)}
  
sp {add*content*south
  (state <s> ^superstate nil
             ^io.input-link.my-location.south.content <c>)
 -->
  (<s> ^content-south <c>)}
  
sp {add*content*west-west
  (state <s> ^superstate nil
             ^io.input-link.my-location.west.west.content <c>)
 -->
  (<s> ^content-west-west <c>)}
  
sp {add*content*east-east
  (state <s> ^superstate nil
             ^io.input-link.my-location.east.east.content <c>)
 -->
  (<s> ^content-east-east <c>)}

sp {add*content*north-north
  (state <s> ^superstate nil
             ^io.input-link.my-location.north.north.content <c>)
 -->
  (<s> ^content-north-north <c>)}
  
sp {add*content*south-south
  (state <s> ^superstate nil
             ^io.input-link.my-location.south.south.content <c>)
 -->
  (<s> ^content-south-south <c>)}
  
sp {add*content*south-east
  (state <s> ^superstate nil
             ^io.input-link.my-location.south.east.content <c>)
 -->
  (<s> ^content-south-east <c>)}
  
sp {add*content*south-west
  (state <s> ^superstate nil
             ^io.input-link.my-location.south.west.content <c>)
 -->
  (<s> ^content-south-west <c>)}
  
sp {add*content*north-east
  (state <s> ^superstate nil
             ^io.input-link.my-location.north.east.content <c>)
 -->
  (<s> ^content-north-east <c>)}
  
sp {add*content*north-west
  (state <s> ^superstate nil
             ^io.input-link.my-location.north.west.content <c>)
 -->
  (<s> ^content-north-west <c>)}
######################## Operator proposals ###################################

# Propose*move:
# If there is normalfood, bonusfood, eater, or empty in an adjacent cell, 
#    propose move in the direction of that cell
#    and indicate that this operator can be selected randomly.
sp {propose*move
   (state <s> ^io.input-link.my-location.<dir>.content <content> <> wall)
-->
   (<s> ^operator <o> + =)
   (<o> ^name move
        ^direction <dir>
        ^content <content>)}

########################## Application rules ##############################

# Apply*move
# If the move operator for a direction is selected,
#    generate an output command to move in that direction.

sp {apply*move
   (state <s> ^io.output-link <ol>
              ^operator <o>)
   (<o> ^name move
        ^direction <dir>)
-->
   (<ol> ^move.direction <dir>)}  

# Apply*move*remove-move:
# If the move operator is selected,
#    and there is a completed move command on the output link,
#    then remove that command.

sp {apply*move*remove-move
   (state <s> ^io.output-link <ol>
              ^operator.name move)
   (<ol> ^move <direction>)
   (<direction> ^status complete)
-->
   (<ol> ^move <direction> -)}


#################### Operator elaboration #################
sp {elaborate*next-content
  (state <s> ^io.input-link.my-location.<dir> <d>
             ^operator <o> +
             ^directions.<dir> <opp>)
  (<o> ^name move
       ^direction <dir>)
   (<opp> ^left <left>
          ^straight <straight>
          ^right <right>)
  (<d> ^<left>.content <con1>
       ^<straight>.content <con2>
       ^<right>.content <con3>)
-->
  (<o> ^content-left <con1>
       ^content-straight <con2>
       ^content-right <con3>)}
#################### RL templates ######################################

# Good rule
sp {RL*test-contents
  (state <s> ^operator <o> +)
   (<o> ^name move
        ^content <content>)
-->
  (<s> ^operator <o> = 0)}
   
# Bad rule
#sp {RL*test-nothing
#   (state <s> ^operator <o> +)
#-->
#   (<s> ^operator <o> = 0)}

sp {RL*test-next-contents
  (state <s> ^operator <o> +)
  (<o> ^name move
       ^content-left <con1>
       ^content-straight <con2>
       ^content-right <con3>)
-->
  (<s> ^operator <o> = 0)}
  
sp {RL*test-all-contents
  (state <s> ^operator <o> +
             ^content-west <cw>
             ^content-east <ce>
             ^content-south <cs>
             ^content-north <cn>
             ^content-west-west <cww>
             ^content-east-east <cee>
             ^content-south-south <css>
             ^content-north-north <cnn>
             ^content-north-east <cne>
             ^content-north-west <cnw>
             ^content-south-east <cse>
             ^content-south-west <csw>)
  (<o> ^name move
       ^direction <dir>)
-->
  (<s> ^operator <o> = 0)}

#sp {record*score*init
#    (state <s> ^operator <o>
#               ^io.input-link.eater.score <sc>
#              -^prev-score )
#    -->
#    (<s> ^prev-score <sc>)}
    
#sp {record*score
#    (state <s> ^operator <o>
#               ^io.input-link.eater.score <sc>
#               ^prev-score <ps> <> <sc>)
# -->
#    (<s> ^prev-score <ps> -)
#    (<s> ^prev-score <sc>)}
    

#sp {compute*reward
#    (state <s> ^io.input-link.eater.score <sc>
#	       ^prev-score <ps>
#	       ^io.reward <r>)
#-->
#    (<r> ^score (- <sc> <ps>))}

############## Symbolic preferences

#sp {select*move*avoid-empty-eater
#   (state <s> ^operator <o1> +)
#   (<o1> ^name move 
#         ^content << empty eater >>)
#-->
#   (<s> ^operator <o1> <)}
   
#sp {select*move*bonusfood-better-than-normalfood-empty
#   (state <s> ^operator <o1> +
#              ^operator <o2> +)
#   (<o1> ^name move 
#         ^content bonusfood)
#   (<o2> ^name move 
#         ^content << normalfood empty >>)
#-->
#   (<s> ^operator <o1> > <o2>)}


############## Record keeping ##########################33

sp {performance*init-data
    (state <s> ^superstate nil
               ^io.input-link.eater <e> 
               ^operator.name move
              -^performance)
    (<e> ^score <score>
         ^x <x>
         ^y <y>)
-->
    (<s> ^performance <p>) 
    (<p> ^score <score>
         ^prev-score 0
         ^x <x>
         ^y <y>
         ^move-count 1)
}
 
sp {compute*reward
    (state <s> ^superstate nil
               ^io.reward <r>
               ^performance <p>)
    (<p> ^score <score>
         ^prev-score <old-score>)
-->
    (<r> ^eaten (- <score> <old-score>))
}

sp {performance*update-data
    (state <s> ^superstate nil
               ^io.input-link <il>
	         ^operator.name move
               ^performance <p>)
    (<il> ^eater <e>) 
    (<e> ^score <score>
         ^x <x>
         ^y <y>)
   -(<p> ^score <score>
         ^x <x>
         ^y <y>)
    (<p> ^move-count <n>
         ^score <old-score>)
-->
    (<s> ^performance <p> -
         ^performance <p-new>)
    (<p-new> ^score <score>
       ^prev-score <old-score>
             ^x <x>
             ^y <y>
             ^move-count (+ 1 <n>))
   # (tcl |puts $fileId | <score>) 
    # [expr double(| <score> |) / | <n> |]|)
}

