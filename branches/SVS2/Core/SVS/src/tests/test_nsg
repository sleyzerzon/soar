#!/bin/sh

# Build some scene graphs and compare the calculated world coordinates
# to a reference set generated by python cgkit.

buildsg='./buildsg'
tests=test_nsg.in       # graph specifications, blank line between every graph
ref=test_nsg.ref        # reference coordinates generated by cgkit
dthresh=0.01            # max percent difference between coordinate values

awk '
	# run buildsg with every set of sgel commands in tests
	BEGIN {
		prog = "'$buildsg'" 
		RS = ""
	} 
	{
		print $0 | prog
		close(prog)
		print ""
	}' $tests | \
awk '
	# sort nodes canonically to be compared
	BEGIN {
		RS = ""
		FS = "\n"
		sort = "sort -k 1,2 -nk 2"
		pr = 0.1
	}
	{
		sep = ""
		for (i = 1; i <= NF; i++) {
			if ($i !~ /[ \t]/) {
				node = $i
			} else {
				printf sep " " node " " $i | sort
				sep = "\n"
			}
		}
		close(sort)
		print ""
	}' >test_nsg.out

awk '
	# compare the generated coordinate values to the reference
	BEGIN {
		ref = "'"$ref"'"
		dthresh = '$dthresh'
	}
	NF == 0 {
		if ((getline < ref) <= 0) {
			print "number of nodes different\n"
			exit 1
		}
		if ($0 !~ /^[ \t]*$/) {
			printf "%d: graphs have different numbers of nodes\n", NR
			exit 1
		}
	}
	NF == 4 {
		if ((getline r < ref) <= 0) {
			print "number of nodes different\n"
			exit 1
		}
		split(r, ra)
		if (ra[1] != $1) {
			printf "%d: node names different\n", NR
			exit 1
		}
		for (i=2; i<=4; i++) {
			diff = 0
			if (ra[i] == 0) {
				if ($i < -dthresh || $i > dthresh ) {
					diff = 1
				}
			} else {
				d = (ra[i] - $i) / ra[i]
				if (d < -dthresh || d > dthresh) {
					diff = 1
				}
			}
			if (diff) {
				printf "%d.%d: values signifcantly different\n", NR, i
				exit 1
			}
		}
	}' <test_nsg.out
