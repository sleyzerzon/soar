#!/bin/sh

# Build some scene graphs and compare the calculated world coordinates
# to a reference set generated by cgkit.

buildsg='../buildsg'
tests=sgel_tests
ref=sgel_ref
dthresh=0.01

awk 'BEGIN {prog = "'$buildsg'"; RS = ""} { print $0 | prog; close(prog); print ""}' $tests | awk '
BEGIN {
	RS = ""
	FS = "\n"
	sort = "sort -k 1 -nk 2"
	pr = 0.1
}
{
	sep = ""
	for (i = 1; i <= NF; i++) {
		if ($i !~ /[ \t]/) {
			node = $i
		} else {
			printf sep " " node " " $i | sort
			sep = "\n"
		}
	}
	close(sort)
	print ""
}' | awk '
	BEGIN {
		ref = "'"$ref"'"
		dthresh = '$dthresh'
	}
	NF == 0 {
		if ((getline < ref) <= 0) {
			print "number of nodes different\n"
			exit 1
		}
	}
	NF == 4 {
		if ((getline r < ref) <= 0) {
			print "number of nodes different\n"
			exit 1
		}
		split(r, ra)
		if (ra[1] != $1) {
			printf "%d: node names different\n", NR
			exit 1
		}
		for (i=2; i<=4; i++) {
			diff = 0
			if (ra[i] == 0) {
				if ($i < -dthresh || $i > dthresh ) {
					diff = 1
				}
			} else {
				d = (ra[i] - $i) / ra[i]
				if (d < -dthresh || d > dthresh) {
					diff = 1
				}
			}
			if (diff) {
				printf "%d.%d: values signifcantly different\n", NR, i
				exit 1
			}
		}
	}'
