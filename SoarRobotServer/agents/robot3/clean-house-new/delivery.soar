# TASKS

#smem --add {
#   (<task01> ^type task
#             ^object <object01>
#             ^destination <dest01>)
#   (<object01> ^color green
#               ^type block)
#   (<dest01> ^id 3)
#}

sp {interrupt
   (state <s> ^operator.name recursive-retrieve)
-->
   #(interrupt)
}

# DELIVERY PROBLEM SPACE

sp {robot*propose*delivery
   (state <s> ^name robot
             -^io.input-link.self.area -1
              ^current-mission <cm>)
   (<cm> ^name delivery
         ^status executing)
-->
   (<s> ^operator <op> + =)
   (<op> ^name delivery)
}

# ELABORATIONS

# tasks

sp {delivery*elaborate
   (state <s> ^name delivery
              ^top-state <ts>)
   (<ts> ^tasks <tasks>)
-->
   (<s> ^tasks <tasks>)
}

# PREFERENCES

sp {delivery*compare*pickup*putdown
   (state <s> ^name delivery
              ^operator <o1> +
              ^operator <o2> +)
   (<o1> ^name pickup-block)
   (<o2> ^name move-to-room-center)
-->
   (<s> ^operator <o2> > <o1>)
}

# OPERATORS

# retrieve-all-tasks

sp {delivery*propose*retrieve-all-tasks
   (state <s> ^name delivery
             -^top-state.all-tasks-retrieved
              ^tasks)
-->
   (<s> ^operator <op> + = >)
   (<op> ^name retrieve-all-tasks)
}

sp {delivery*apply*retrieve-all-tasks*first-query
   (state <s> ^operator.name retrieve-all-tasks
              ^smem.command <scmd>)
-->
   (<scmd> ^query.type task)
}

sp {delivery*apply*retrieve-all-tasks*next-query
   (state <s> ^operator.name retrieve-all-tasks
              ^smem <smem>
              ^tasks <tasks>)
   (<smem> ^command <scmd>
           ^result <sres>)
   (<sres> ^success
           ^retrieved <task>)
-->
   (<tasks> ^task <task>)
   (<scmd> ^prohibit <task>)
}

sp {delivery*apply*retrieve-all-tasks*done
   (state <s> ^operator.name retrieve-all-tasks
              ^smem <smem>
              ^top-state <ts>)
   (<smem> ^command <scmd>
           ^result.failure)
   (<scmd> ^{<cmd> << query prohibit >>} <arg>)
-->
   (<scmd> ^<cmd> <arg> -)
   (<ts> ^all-tasks-retrieved yes)
}

# store-task

# recursive-retrieve

sp {delivery*propose*recursive-retrieve*ecological-doors
   (state <s> ^name delivery
              ^top-state <ts>
              ^tasks.task <lti>)
   (<ts> ^parameters <params>
         ^current-location.type door)
   (<params> ^tasks-held-in smem
             ^method-ecological-doors yes)
   (<task> -^all-retrieved)
-->
   (<s> ^operator <op> + = >)
   (<op> ^name recursive-retrieve
         ^lti <lti>)
}

#sp {delivery*propose*recursive-retrieve*ecological-entry
# FIXME this rule will fire anytime the agent is in a room
# need to be more discriminatory than this
#   (state <s> ^name delivery
#              ^top-state <ts>
#              ^tasks.task <task>)
#   (<ts> ^parameters <params>
#         ^current-location.type door)
#   (<params> ^tasks-held-in smem
#             ^method-ecological-entry yes)
#   (<task> -^<< object destination >>.<attr>)
#-->
#   (<s> ^operator <op> + = >)
#   (<op> ^name recursive-retrieve
#         ^task <task>)
#}

sp {recursive-retrieve*propose*initialize
   (state <s> ^name recursive-retrieve
             -^to-be-retrieved
             -^retrieved)
-->
   (<s> ^operator <op> + = >)
   (<op> ^name initialize)
}

sp {recursive-retrieve*apply*initialize
   (state <s> ^name recursive-retrieve
              ^operator.name initialize
              ^superstate.operator.lti <lti>)
-->
   (<s> ^to-be-retrieved.lti <lti>
        ^retrieved <retrieved>)
}

sp {recursive-retrieve*propose*retrieve
   (state <s> ^name recursive-retrieve
              ^to-be-retrieved.lti <lti>)
-->
   (<s> ^operator <op> + = >)
   (<op> ^name retrieve
         ^lti <lti>)
}

sp {recursive-retrieve*apply*retrieve*retrieve
   (state <s> ^name recursive-retrieve
              ^operator <op>
              ^smem.command <scmd>
             -^retrieved.lti <lti>)
   (<op> ^name retrieve
         ^lti <lti>)
-->
   (<scmd> ^retrieve <lti>)
}

sp {recursive-retrieve*apply*retrieve*copy-children
   (state <s> ^name recursive-retrieve
              ^operator <op>
              ^smem.result.retrieved <lti>
              ^to-be-retrieved <to-be-retrieved>
              ^retrieved <retrieved>)
   (<op> ^name retrieve
         ^lti <lti>)
   (<lti> ^<attr> <val>)
   (<retrieved> -^lti <val>)
-->
   (<to-be-retrieved> ^lti <val>)
}

sp {recursive-retrieve*apply*retrieve*remove-command
   (state <s> ^name recursive-retrieve
              ^operator <op>
              ^smem <smem>
              ^to-be-retrieved <to-be-retrieved>
              ^retrieved <retrieved>)
   (<op> ^name retrieve
         ^lti <lti>)
   (<smem> ^command <scmd>
           ^result.<< success failure bad-cmd >>)
   (<scmd> ^retrieve <lti>)
   (<to-be-retrieved> ^lti <lti>)
-->
   (<scmd> ^retrieve <lti> -)
   (<to-be-retrieved> ^lti <lti> -)
   (<retrieved> ^lti <lti>)
}

sp {recursive-retrieve*propose*done
   (state <s> ^name recursive-retrieve
             -^to-be-retrieved.lti
              ^retrieved.lti)
-->
   (<s> ^operator <op> + = >)
   (<op> ^name done)
}

sp {recursive-retrieve*apply*done
   (state <s> ^name recursive-retrieve
              ^operator.name done
              ^superstate.operator.lti <lti>)
-->
   (<lti> ^all-retrieved yes)
}

# pick up

sp {delivery*propose*pickup-block
   (state <s> ^name delivery
              ^io.input-link.objects.object <obj>
              ^tasks.task <task>)
   (<task> ^object <desc>)
   (<obj> ^id <id>)
   # check that the object has not been forgotten
   (<desc> ^<attr>)
   # check that the object is right for the task
  -{ (<desc> ^<attr> <val>)
    -(<obj> ^<attr> <val>) }
-->
   (<s> ^operator <op> + = >)
   (<op> ^name pickup-block
         ^task <task>
         ^id <id>)
}

sp {delivery*apply*pickup-block*store-object-id
   (state <s> ^name delivery
              ^operator <op>)
   (<op> ^name pickup-block
         ^task <task>
         ^id <id>)
   (<task> -^object-id)
-->
   (<task> ^object-id <id>)
}

# put down

sp {delivery*propose*move-to-room-center
   (state <s> ^name delivery
              ^io.input-link.self.carry.object.id <id>
              ^top-state.current-location <room>
              ^tasks.task <task>)
   (<task> ^object-id <id>
           ^destination <dest>)
   # check that the destination has not been forgotten
   (<dest> ^<attr>)
   # check that we are in the right location
  -{ (<dest> ^<attr> <val>)
    -(<room> ^<attr> <val>) }
-->
   (<s> ^operator <op> + = >)
   (<op> ^name move-to-room-center
         ^object <obj>)
}

sp {move-to-room-center*apply*drop-block*complete-task
   (state <s> ^name move-to-room-center
              ^operator <op>
              ^superstate <ss>)
   (<op> ^name drop-block
         ^actions.drop-object.id <id>)
   (<ss> ^name delivery
         ^operator.object <obj>
         ^tasks <tasks>)
   (<tasks> ^task <task>)
   (<task> ^object <obj>)
   (<obj> ^id <id>)
-->
   (<tasks> ^task <task> -)
}

# circuit

sp {delivery*propose*circuit
   (state <s> ^name delivery
              ^current-location.id <id>)
-->
   (<s> ^operator <op> + = <)
   (<op> ^name circuit
         ^area <a01> <a02> <a03> <a04> <a05> <a06> <a07> <a08> <a09> <a10> <a11> <a12>)
   (<a01> ^next <a02>
          ^id 0)
   (<a02> ^next <a03>
          ^id 5)
   (<a03> ^next <a04>
          ^id 10)
   (<a04> ^next <a05>
          ^id 15)
   (<a05> ^next <a06>
          ^id 20)
   (<a06> ^next <a07>
          ^id 25)
   (<a07> ^next <a08>
          ^id 30)
   (<a08> ^next <a09>
          ^id 35)
   (<a09> ^next <a10>
          ^id 40)
   (<a10> ^next <a11>
          ^id 45)
   (<a11> ^next <a12>
          ^id 50)
   (<a12> ^next <a01>
          ^id 55)
}

sp {circuit*propose*go-to-area
   (state <s> ^name circuit
              ^superstate.operator <sop>
              ^top-state.current-location.id <area-id>)
   (<sop> ^name circuit
          ^area <area>)
   (<area> ^next <next-area>
           ^id <area-id>)
   (<next-area> ^id <next-id>)
-->
   (<s> ^operator <op> + = >)
   (<op> ^name go-to-area
         ^type go-to-area
         ^area <next-area>)
}
